---
- name: Deploy Flask App to Localhost
  hosts: webservers
  become: yes
  tasks:

    - name: Update apt packages
      apt:
        update_cache: yes
        force_apt_get: yes

    - name: Install required system packages
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - git
          - nginx
        state: present

    - name: Ensure app directory exists
      file:
        path: /home/ahmed/app
        state: directory
        mode: '0755'

    - name: Copy Flask app files to target directory
      copy:
        src: ../app/
        dest: /home/ahmed/app/
        owner: ahmed
        mode: '0644'

    - name: Create virtual environment for Flask app
      command: python3 -m venv /home/ahmed/app/venv
      args:
        creates: /home/ahmed/app/venv

    - name: Install required Python packages inside venv
      shell: |
        source /home/ahmed/app/venv/bin/activate && pip install --upgrade pip && pip install -r /home/ahmed/app/requirements.txt
      args:
        executable: /bin/bash

    - name: Kill any existing Flask app process (if running)
      shell: |
        if pgrep -f "python3 /home/ahmed/app/server.py" > /dev/null; then
          pkill -f "python3 /home/ahmed/app/server.py"
        fi
      ignore_errors: yes

    - name: Start Flask application in background
      shell: |
        source /home/ahmed/app/venv/bin/activate && nohup python3 /home/ahmed/app/server.py > /home/ahmed/app/server.log 2>&1 &
      args:
        chdir: /home/ahmed/app/
        executable: /bin/bash

    - name: Wait for Flask app to start
      wait_for:
        port: 5000
        delay: 3
        timeout: 20

    - name: Verify Flask app is running
      shell: |
        if pgrep -f "python3 /home/ahmed/app/server.py" > /dev/null; then
          echo "✅ Flask app is running successfully!"
          echo "Access it at: http://127.0.0.1:5000"
        else
          echo "❌ Flask app failed to start."
          exit 1
        fi
      register: app_status
      changed_when: false

    #######################
    # Nginx Reverse Proxy #
    #######################

    - name: Create Nginx reverse proxy config for Flask app
      copy:
        dest: /etc/nginx/sites-available/flask_app
        content: |
          server {
              listen 80;
              server_name _;

              location / {
                  proxy_pass http://127.0.0.1:5000;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/flask_app
        dest: /etc/nginx/sites-enabled/flask_app
        state: link
        force: yes

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Restart Nginx
      service:
        name: nginx
        state: restarted

    - name: Ensure firewall allows HTTP traffic (UFW)
      ufw:
        rule: allow
        port: 80
        proto: tcp
      ignore_errors: yes


