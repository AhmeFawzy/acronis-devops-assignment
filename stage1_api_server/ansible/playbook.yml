---
- name: Deploy Flask App to Localhost
  hosts: webservers
  become: yes
  vars_files:
    - vars.yml
  tasks:

    - name: Update apt packages
      apt:
        update_cache: yes
        force_apt_get: yes

    - name: Install required system packages
      apt:
        name:
          - python3
          - python3-pip
          - python3-venv
          - git
          - nginx
        state: present

    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'
        owner: "{{ app_user }}"

    - name: Copy Flask app files to target directory
      copy:
        src: ../app/
        dest: "{{ app_dir }}/"
        owner: "{{ app_user }}"
        mode: '0644'

    - name: Create virtual environment for Flask app
      command: python3 -m venv "{{ app_dir }}/venv"
      args:
        creates: "{{ app_dir }}/venv"

    - name: Install required Python packages inside venv
      shell: |
        source {{ app_dir }}/venv/bin/activate && \
        pip install --upgrade pip && \
        pip install -r {{ app_dir }}/requirements.txt
      args:
        executable: /bin/bash

    - name: Kill any existing Flask app process (if running)
      shell: |
        if pgrep -f "python3 {{ app_dir }}/server.py" > /dev/null; then
          pkill -f "python3 {{ app_dir }}/server.py"
        fi
      ignore_errors: yes

    - name: Start Flask application in background
      shell: |
        source {{ app_dir }}/venv/bin/activate && \
        nohup python3 {{ app_dir }}/server.py > {{ app_dir }}/server.log 2>&1 &
      args:
        chdir: "{{ app_dir }}"
        executable: /bin/bash

    - name: Wait for Flask app to start
      wait_for:
        port: "{{ flask_port }}"
        delay: 3
        timeout: 20

    - name: Verify Flask app is running
      shell: |
        if pgrep -f "python3 {{ app_dir }}/server.py" > /dev/null; then
          echo "✅ Flask app is running successfully!"
          echo "Access it at: http://127.0.0.1:{{ flask_port }}"
        else
          echo "❌ Flask app failed to start."
          exit 1
        fi
      register: app_status
      changed_when: false

    #######################
    # Nginx Reverse Proxy #
    #######################

    - name: Create Nginx reverse proxy config for Flask app
      copy:
        dest: /etc/nginx/sites-available/flask_app
        content: |
          server {
              listen {{ nginx_port }};
              server_name _;

              location / {
                  proxy_pass http://127.0.0.1:{{ flask_port }};
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/flask_app
        dest: /etc/nginx/sites-enabled/flask_app
        state: link
        force: yes

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent

    - name: Restart Nginx
      service:
        name: nginx
        state: restarted

    - name: Ensure firewall allows HTTP traffic (UFW)
      ufw:
        rule: allow
        port: "{{ nginx_port }}"
        proto: tcp
      ignore_errors: yes
